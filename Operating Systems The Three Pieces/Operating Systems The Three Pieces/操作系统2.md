# æ“ä½œç³»ç»Ÿ2
[TOC]
## ç¬¬ä¹æ¬¡è¯¾ï¼ˆçŠ¶æ€æœºæ¨¡å‹ï¼‰
è°æ¥åŠ è½½æ“ä½œç³»ç»Ÿï¼Ÿä¸ºäº†è®©è®¡ç®—æœºç³»ç»Ÿè¿è¡Œç¨‹åºï¼Œä¸€å®šå­˜åœ¨ç€è½¯ä»¶/ç¡¬ä»¶ä¹‹é—´çš„çº¦å®šã€‚æ‰€ä»¥èŠ¯ç‰‡å‚å•†ï¼ˆAMDã€Intelï¼‰ã€ç¡¬ä»¶å‚å•†ï¼ˆæ˜¾å¡ã€ä¸»æ¿ã€å†…å­˜ï¼‰ã€æ“ä½œç³»ç»Ÿå‚å•†ï¼ˆWindowsã€Appleï¼‰ä¹‹é—´è¦ç›¸äº’åˆä½œï¼Œç”±äºå¸‚åœºç«äº‰é—®é¢˜ï¼Œæœ‰ä¸æ­¢ä¸€ç§è½¯ç¡¬ä»¶çº¦å®šã€‚

**æ•´ä¸ªè®¡ç®—æœºç³»ç»Ÿä¹Ÿæ˜¯ä¸€ä¸ªçŠ¶æ€æœº**ã€‚è®¡ç®—æœºåŠ ç”µå¯åŠ¨åï¼Œå³CPU RESETï¼ŒèŠ¯ç‰‡å‚å•†çš„ç”µè·¯ä½¿å¾—å¤„ç†å™¨å¤„äºæŸä¸ªç¡®å®šçš„çŠ¶æ€ï¼š

CPU Reset (IntelÂ® 64 and IA-32 Architectures Software Developerâ€™s Manual, Volume 3A/3B)
![](http://jyywiki.cn/pages/OS/img/intel-cpu-reset.png)

- å¯„å­˜å™¨ä¼šæœ‰åˆå§‹çŠ¶æ€
	- EIP = 0x0000fff0
	- CR0 = 0x60000010
	16-bit æ¨¡å¼
	- EFLAGS = 0x00000002
	interrupt disabled
	- å…¶ä»–å¯„å­˜å™¨æ˜¯Undefined
- å…¶ä»–ï¼šå¤„ç†å™¨çš„å¤§éƒ¨åˆ†ç‰¹æ€§å¤„äºå…³é—­çŠ¶æ€ï¼Œä¾‹å¦‚ç¼“å­˜ã€è™šæ‹Ÿå­˜å‚¨ç­‰ã€‚



`ffff0` é€šå¸¸æ˜¯ä¸€æ¡å‘ firmware è·³è½¬çš„ `jmp `æŒ‡ä»¤ã€‚**firmwareï¼ˆå›ºä»¶ï¼‰**æ˜¯ä½äºä¸»æ¿ROMä¸Šçš„ä¸€æ®µä»£ç ï¼Œç”±ç¡¬ä»¶å‚å•†æä¾›ã€‚

å›ºä»¶ä¼šè¿›è¡Œ*ç¡¬ä»¶æ£€æŸ¥*ã€‚ç„¶å*åŠ è½½æ“ä½œç³»ç»Ÿ*ã€‚ä»¥x86ä¸ºä¾‹ï¼ŒBIOSä¼šå°†ç”¨æˆ·æ•°æ®ï¼ˆæ“ä½œç³»ç»Ÿã€åŠ è½½å™¨ç­‰ï¼‰ä»ç£ç›˜åŠ è½½åˆ°å†…å­˜ã€‚å‡†ç¡®ç‚¹æ¥è¯´ï¼Œå®ƒä¼šæŠŠç¬¬ä¸€ä¸ªå¯å¼•å¯¼è®¾å¤‡ï¼ˆFloppyã€HDDã€SDDï¼‰çš„ç¬¬ä¸€ä¸ªä¸»æ‰‡åŒºï¼ˆæœ€åä¸¤ä¸ªå­—èŠ‚ä¸€å®šæ˜¯0xaa55ï¼Œä½œä¸ºæ ‡è¯†ç¬¦ï¼‰çš„512å­—èŠ‚åŠ è½½åˆ°ç‰©ç†å†…å­˜çš„ `7c00` ä½ç½®ã€‚åœ¨å°†æ§åˆ¶æƒè½¬äº¤ç»™æ“ä½œç³»ç»Ÿåï¼Œå®ƒè¿˜å¯ä»¥*å‘æ“ä½œç³»ç»Ÿæä¾›ç®€å•çš„ç¡¬ä»¶æœåŠ¡*ï¼Œä¾‹å¦‚ä¸­æ–­ã€è®¿é—®ç¡¬ç›˜ç­‰ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸€èˆ¬ä¸éœ€è¦ã€‚

CPUä¸ä¸»æ¿çš„å…³ç³»ï¼šCPUé€šè¿‡æ€»çº¿å’Œå¤–éƒ¨è®¾å¤‡é€šä¿¡ï¼Œè€Œä¸»æ¿å¿…é¡»è®¾è®¡å‡ºä¸CPUç›¸å…¼å®¹çš„ç»“æ„ï¼ˆæ€»çº¿ã€æ¥å£ç­‰ï¼‰æ‰èƒ½ä½¿æ•´ä¸ªè®¡ç®—æœºç³»ç»Ÿæ­£å¸¸å·¥ä½œã€‚

> ä»¥å‰firmwareä¼šå…ˆæŸ¥è¯¢è½¯ç›˜å†æŸ¥è¯¢ç¡¬ç›˜ã€‚æ‰€ä»¥è½¯ç›˜çš„é»˜è®¤æ ‡è¯†ç¬¦å°±ç”¨Aã€Bï¼Œè€Œç¡¬ç›˜çš„é»˜è®¤æ ‡è¯†ç¬¦æ˜¯C



ç°åœ¨Firmwareæœ‰ä¸¤ç§ï¼š

- BIOSï¼ˆé€æ¸è¦è¢«æ·˜æ±°ï¼‰

- UEFIï¼šå„ä¸ªå‚å•†åˆ¶å®šçš„ç»Ÿä¸€æ ‡å‡†ã€‚åŠŸèƒ½æ›´ä¸°å¯Œï¼Œä¾‹å¦‚æ”¯æŒæ–‡ä»¶ç³»ç»Ÿï¼ŒæŒ‡çº¹è®¤è¯ç­‰ã€‚å¯é æ€§ã€å®‰å…¨æ€§æ›´å¥½ã€‚

	![](picture/EFI.png)





## ç¬¬10æ¬¡è¯¾ ï¼ˆçŠ¶æ€æœºæ¨¡å‹çš„åº”ç”¨ï¼‰

### ç‰©ç†ä¸–ç•Œ

å®è§‚ç‰©ç†ä¸–ç•Œï¼ˆç‰›é¡¿ï¼‰è¿‘ä¼¼äºdeterministicçš„çŠ¶æ€æœºã€‚çŠ¶æ€è½¬ç§»å°±æ˜¯ç‰©ç†å®šç†ã€‚è€Œå¾®è§‚ä¸–ç•Œå¯èƒ½æ˜¯non-deterministicï¼Œä¾‹å¦‚é‡å­åŠ›å­¦ã€‚

[Conway's game of life](https://playgameoflife.com/)æŠŠç‰©ç†ä¸–ç•Œå»ºæ¨¡æˆåŸºæœ¬ç²’å­çš„è¿åŠ¨ï¼Œæ˜¯ä¸€ä¸ªè®¡ç®—æœºä¸ç‰©ç†ç»“åˆçš„åº”ç”¨ã€‚è€Œä¸”è¿˜è¢«è¯æ˜æ˜¯å›¾çµå®Œå¤‡çš„ã€‚

çŠ¶æ€æœº + ä¸€äº›å…¬ç†è¿˜å¯ä»¥å¯¹å¹³è¡Œå®‡å®™ã€æ—¶é—´ç©¿æ¢­ç­‰æ¦‚å¿µåšå‡ºå®šä¹‰ï¼Œè™½ç„¶å¯èƒ½ä¸åˆ‡å®é™… ğŸ˜‘ã€‚

æ¨èé˜…è¯»çš„æ–‡ç« ï¼š[Why philosophers should care about computational complexity, Ch. 10](https://www.scottaaronson.com/papers/philos.pdf)

> ä¸ªäººè®¤ä¸ºä»¥çŠ¶æ€æœºè§†è§’æ¥ç†è§£ä¸–ç•Œæ˜¯å¾ˆè‚¤æµ…çš„ğŸ™ƒï¼Œä½†ä¹Ÿæä¾›äº†å¦ä¸€ä¸ªç†è§£ä¸–ç•Œçš„è§’åº¦ã€‚

### ç¼–è¯‘å™¨ä¸CPUä¼˜åŒ–

ç¼–è¯‘å™¨ä»¥åŠCPUè¶…æ ‡é‡/ä¹±åºæ‰§è¡Œç­‰æŠ€æœ¯ï¼Œå¯ä»¥ä½¿å¾—åœ¨ç¨‹åºçŠ¶æ€æœºç¿»è¯‘æˆæ•°å­—ç”µè·¯çŠ¶æ€æœºæ—¶ï¼Œåªéœ€ä¿è¯åœ¨å¯è§‚æµ‹è¡Œä¸ºä¸€è‡´å‰æä¸‹ï¼Œä¿®æ”¹çŠ¶æ€æœºä»¥åšä¼˜åŒ–å·¥ä½œã€‚

ä¸€ä¸ªä¾‹å­[ilp-demo.c](http://jyywiki.cn/pages/OS/2022/demos/ilp-demo.c)ã€‚æµ‹è¯•ç»“æœè¡¨æ˜ï¼Œç¨‹åºè¿è¡Œé€Ÿåº¦è¿œè¿œè¶…è¿‡ä½ çš„CPUä¸»é¢‘çš„ï¼Œè¿™å¾—ç›Šäºç¼–è¯‘å™¨ä»¥åŠCPUæ‰€åšçš„ä¼˜åŒ–ã€‚

### æŸ¥çœ‹çŠ¶æ€æœº

gdb/straceä¸ä»…å¯ä»¥è§‚å¯ŸçŠ¶æ€æœºçš„æ‰§è¡Œï¼Œè€Œä¸”è¿˜å¯ä»¥ç”šè‡³è®°å½•å’Œæ”¹å˜çŠ¶æ€æœºçš„æ‰§è¡Œï¼Œä¾‹å¦‚çŠ¶æ€å›æº¯ä»¥åŠçŠ¶æ€æ‹·è´ã€‚



ç¨‹åºæ‰§è¡Œæ˜¯éšæ—¶é—´ â€œå‰è¿›â€ çš„ $s_0 \to s_1 \to s_2 \to ...$ã€‚è®°å½•æ‰€æœ‰$s_i$çš„å¼€é”€å¤ªå¤§ ($s_i$ç”±å†…å­˜ + å¯„å­˜å™¨ç»„æˆ)ã€‚ä½†ä¸€æ¡æŒ‡ä»¤çš„**side-effect **é€šå¸¸æœ‰é™ï¼Œåªè®°å½•åˆå§‹çŠ¶æ€ï¼Œå’Œæ¯æ¡æŒ‡ä»¤å‰åçŠ¶æ€çš„å·®å¼‚ $s_0,Î”0,Î”1,â€¦$

- æ­£å‘æ‰§è¡Œï¼š$s_{i+1} = s_i + \Delta_0$
- åå‘æ‰§è¡Œï¼š$s_{i-1} = s_i e \Delta_0^{-1}$

å¯¹äºdeterministicæŒ‡ä»¤çš„å·®å¼‚ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°è¿›è¡Œæ’¤é”€å·¥ä½œã€‚è€Œä¸”ä»…éœ€è®°å½•åˆå§‹çŠ¶æ€ï¼Œé‚£ä¹ˆå°±å¯ä»¥å¤ç°ç¨‹åºæ‰§è¡Œçš„ç»“æœï¼Œä¸¾ä¸ªä¾‹å­å‡è®¾$ s_0$ æ‰§è¡Œ 1,000,000 æ¡ç¡®å®šçš„æŒ‡ä»¤åå¾—åˆ° s'ï¼Œé‚£ä¹ˆåªè¦è®°å½• $s_0$å’Œ 1,000,000ï¼Œå°±èƒ½é€šè¿‡ â€œå†æ‰§è¡Œä¸€æ¬¡â€ æ¨å¯¼å‡º *s*â€²ã€‚

å¯¹äºnon-deterministicçš„æŒ‡ä»¤ï¼Œä¾‹å¦‚ä¸Šé”é¡ºåºã€æ¡ä»¶å˜é‡ã€éšæœºæ•°ã€ä¸­æ–­ã€IOæŒ‡ä»¤ã€‚æˆ‘ä»¬ä»…éœ€ä¿å­˜å®ƒä»¬çš„å½“æ—¶çŠ¶æ€å³å¯ã€‚

rdrandæŒ‡ä»¤çš„å‰¯ä½œç”¨ä»…é™äºå¯„å­˜å™¨ï¼Œæ‰€ä»¥gdbå¯ä»¥ä»¥ä½æˆæœ¬æ¥ä¿å­˜çŠ¶æ€ï¼Œè€Œæœ‰äº›å¤æ‚çš„æŒ‡ä»¤ï¼ˆsyscallï¼‰æ— æ³•ä¿è¯ï¼Œå› ä¸ºgdbæ— æ³•çŸ¥é“å…¨éƒ¨çŠ¶æ€æˆ–è€…ä»£ä»·å¤ªå¤§ã€‚



è¿™ç¯‡è®ºæ–‡è¯´æ˜äº†å¦‚ä½•é‡æ”¾ä¸€æ•´ä¸ªè™šæ‹Ÿæœºçš„æ‰§è¡Œã€‚è¿™å¯¹äºå®‰å…¨æµ‹è¯•ä¸­çš„ç°åœºå¤ç°å¾ˆé‡è¦ã€‚[ReVirt: Enabling intrusion analysis through virtual-machine logging and replay](http://jyywiki.cn/OS/2022/slides/10.slides) (OSDI'02, Best Paper ğŸ…)

ä½ ç”šè‡³å¯ä»¥ç±»æ¯”æ¸¸æˆçš„å›æ”¾æœºåˆ¶ğŸ¤£ï¼Œæ— éå°±æ˜¯ç”¨æ—¥å¿—è®°å½•ç©å®¶çš„è¡Œä¸ºï¼Œå°†æ•´ä¸ªç³»ç»Ÿå˜ä¸ºç¡®å®šæ€§çš„ã€‚



profilerå’Œæ€§èƒ½æ‘˜è¦

æ€§èƒ½æ‘˜è¦æ— éå°±æ˜¯å›ç­”äº†â€œä¸ºäº†åšæŸä»¶äº‹åˆ°åº•èŠ±å»äº†å¤šå°‘èµ„æºâ€ï¼Œæˆ–è€…è¯´â€œä¸€æ®µæ—¶é—´å†…èµ„æºçš„æ¶ˆè€—æƒ…å†µâ€ã€‚

> Premature optimization is the root of all evil. (D. E. Knuth)

å¯¹çŠ¶æ€æœºæ‰§è¡Œè¿›è¡Œé‡‡æ ·ï¼Œç»Ÿè®¡å…³é”®æ€§èƒ½æŒ‡æ ‡ï¼Œç„¶åå»åšæ€§èƒ½åˆ†æã€‚è¿™æ ·æ€§èƒ½æ‘˜è¦éœ€è¦å¯¹ç¨‹åºæ‰§è¡Œæ€§èƒ½å½±å“æœ€å°ï¼Œå¾€å¾€ä¸éœ€è¦ full traceã€‚

å…¶ä¸­å…³é”®æ€§æŒ‡æ ‡åŒ…æ‹¬ï¼š

- å‡½æ•°çš„è°ƒç”¨æ ˆ
- æ‰§è¡Œçš„è¯­å¥
- å…¶ä»–



Linux Kernel perfçš„ä¾‹å­

- perf list, perf stat (-e), perf record, perf report

è¿™æ˜¯å†…æ ¸ä¸ºæˆ‘ä»¬æä¾›çš„ä¸€ä¸ªæ€§èƒ½ç»Ÿè®¡å·¥å…·ã€‚



å·¥ä¸šç•Œç°åœ¨ç”¨ç«ç„°å›¾[The flame graph](https://cacm.acm.org/magazines/2016/6/202665-the-flame-graph/fulltext) è¿›è¡Œæ€§èƒ½åˆ†æã€‚





Model Checkerå¯ä»¥æ¢ç´¢ç¨‹åºçš„çŠ¶æ€ç©ºé—´ï¼Œä¸€äº›å·¥ä¸šç•Œç”¨çš„Model Checkerï¼š

- [TLA+](https://lamport.azurewebsites.net/tla/tla.html) by Leslie Lamport;
- [Java PathFinder (JFP)](https://ti.arc.nasa.gov/tech/rse/vandv/jpf/) å’Œ [SPIN](http://spinroot.com/)



non-deterministicçš„çŠ¶æ€éƒ½å¯ä»¥æ£€æŸ¥ï¼Œä½†çŠ¶æ€ç©ºé—´å¤ªå¤§ï¼Œæ‰€ä»¥è¦å°†ç›¸ä¼¼çŠ¶æ€åˆå¹¶ã€‚åŸºæœ¬æ€è·¯æ˜¯æŠŠçŠ¶æ€éšæœºæ€§ä¿ç•™ç€ï¼Œå»¶è¿ŸçŠ¶æ€çš„å±•å¼€ï¼Œé‚£ä¹ˆè¿™ä¸ªçŠ¶æ€å°†ä¼šåç¼©ï¼Œç­‰çœŸæ­£éœ€è¦è¯¥çŠ¶æ€çš„ç»“æœæ—¶å†æ‰§è¡Œè®¡ç®—ï¼Œå…·ä½“æ¥è¯´æ˜¯é€šè¿‡çº¦æŸæ±‚è§£å™¨å¯¹çŠ¶æ€è¿›è¡Œå±•å¼€ã€‚

ä¸‹é¢ç»™å‡ºä¸€ä¸ªä¾‹å­

~~~c
u32 x = rdrand();
u32 y = rdrand();
if (x > y)
  if (x * x + y * y == 65)
    bug();

~~~

å¦‚æœç›´æ¥å¯¹çŠ¶æ€è¿›è¡Œå±•å¼€ï¼Œé‚£ä¹ˆä¼šæœ‰$2^{64}$ç§çŠ¶æ€ã€‚



- [KLEE: Unassisted and automatic generation of high-coverage tests for complex systems programs](https://dl.acm.org/doi/10.5555/1855741.1855756) (OSDI'08, Best Paper ğŸ…)



## ç¬¬11æ¬¡è¯¾ï¼ˆè¿›ç¨‹ï¼‰

### Q1  æ“ä½œç³»ç»Ÿå¯åŠ¨ååˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ

æ“ä½œç³»ç»Ÿä¼šåŠ è½½ä¸€ä¸ªè¿›ç¨‹initï¼Œå®ƒä¼šå®ŒæˆåŸºæœ¬çš„å·¥ä½œï¼Œä¾‹å¦‚å¯ç”¨shellã€åŠ è½½æ–‡ä»¶ç³»ç»Ÿç­‰ã€‚

[RTFSC](https://elixir.bootlin.com/linux/latest/source/init/main.c#L1555) (latest Linux Kernel)

~~~c
if (!try_to_run_init_process("/sbin/init") ||
	    !try_to_run_init_process("/etc/init") ||
	    !try_to_run_init_process("/bin/init") ||
	    !try_to_run_init_process("/bin/sh"))
		return 0;

	panic("No working init found.  Try passing init= option to kernel. "
	      "See Linux Documentation/admin-guide/init.rst for guidance.");
~~~

- å¦‚æœæ²¡æœ‰æŒ‡å®šå¯åŠ¨é€‰é¡¹ `init=`ï¼ŒæŒ‰ç…§ â€œé»˜è®¤åˆ—è¡¨â€ å°è¯•ä¸€é
- ä»æ­¤ä»¥åï¼ŒLinux Kernel å°±è¿›å…¥åå°ï¼Œæˆä¸º â€œä¸­æ–­/å¼‚å¸¸å¤„ç†ç¨‹åºâ€



æ“ä½œç³»ç»Ÿä¸º (æ‰€æœ‰) ç¨‹åºæä¾› syscallåŒ…æ‹¬ï¼š

- è¿›ç¨‹ç®¡ç†ï¼šforkã€execveã€exit
- å†…å­˜ç®¡ç†ï¼šmmapç­‰
- æ–‡ä»¶ç®¡ç†ï¼šopenã€closeã€readã€writeç­‰
- å…¶ä»–ï¼šç½‘ç»œ



### Q2 æ“ä½œç³»ç»Ÿå¦‚ä½•ç®¡ç†ç¨‹åº (è¿›ç¨‹)ï¼Ÿ

**è™šæ‹ŸåŒ–ï¼šæ“ä½œç³»ç»Ÿåœ¨ç‰©ç†å†…å­˜ä¸­ä¿å­˜å¤šä¸ªçŠ¶æ€æœº**



forkåšä¸€ä»½çŠ¶æ€æœºå®Œæ•´çš„å¤åˆ¶ (å†…å­˜ã€å¯„å­˜å™¨ç°åœº)ï¼Œé™¤äº†forkçš„è¿”å›å€¼ï¼ˆåœ¨çˆ¶è¿›ç¨‹ä¸­è¿”å›å­è¿›ç¨‹çš„PIDï¼Œè€Œåœ¨å­è¿›ç¨‹ä¸­è¿”å›0ï¼‰ä»¥åŠPIDã€‚

è™½ç„¶forkä¹‹åä¸¤ä¸ªç¨‹åºæ˜¯å¹¶å‘çš„ï¼Œä½†æ˜¯å®ƒä»¬æ˜¯å®Œå…¨ç›¸äº’ç‹¬ç«‹çš„ï¼Œæ‰€ä»¥**forkçŠ¶æ€å›¾å¯ä»¥ç®€åŒ–æˆè¿›ç¨‹æ ‘å›¾**ã€‚

å› ä¸ºçŠ¶æ€æœºæ˜¯å¤åˆ¶çš„ï¼Œå› æ­¤æ€»èƒ½æ‰¾åˆ° â€œçˆ¶å­å…³ç³»â€ï¼Œæœ‰äº†è¿›ç¨‹æ ‘ (pstree)

~~~bash
$ :(){ :|:& };:
~~~



stdout tty line buffer

pipeã€file full buffer

setbuf(stdout, NULL) fllush(stdout)





execve()é‡ç½®çŠ¶æ€æœºï¼Œé‡ç½®æˆæŸä¸€ä¸ªç¨‹åºçš„åˆå§‹çŠ¶æ€ã€‚



wait()åŒæ­¥æœºåˆ¶

## å·¥å…·ä½¿ç”¨

ld é“¾æ¥

strace -T æ‰“å°ç³»ç»Ÿè°ƒç”¨æ‰€èŠ±è´¹çš„æ—¶é—´

info local æŸ¥çœ‹å±€éƒ¨å˜é‡

snapshot å°†çŠ¶æ€æ‹·è´

reverse çŠ¶æ€åé€€ã€‚

record full -å¼€å§‹è®°å½•

record stop -ç»“æŸè®°å½•

reverse-step æ—¶é—´æ—…è¡Œè°ƒè¯•

step å°±æ˜¯å•æ­¥æ‰§è¡Œï¼Œä¼šè¿›å…¥åˆ°å‡½æ•°å†…éƒ¨

next æ˜¯åœ¨å•æ­¥æ‰§è¡Œæ—¶ï¼Œä½†ä¸ä¼šè¿›å…¥å‡½æ•°å†…éƒ¨

finishå°±æ˜¯ä½†å•æ­¥æ‰§è¡Œåˆ°å­å‡½æ•°å†…æ—¶ï¼Œç”¨step outå°±å¯ä»¥æ‰§è¡Œå®Œå­å‡½æ•°ä½™ä¸‹éƒ¨åˆ†

